<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Console do Karaokê 🎶</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1, h2 { color: #111; }
    .container { max-width: 1080px; margin: auto; }
    .section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin: 8px 0;
      background: #f9f9f9;
      border-radius: 8px;
    }
    li.atual {
      background: #d1f7c4;
      font-weight: bold;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .tocar { background: #28a745; color: white; }
    .tocar:hover { background: #218838; }
    .remover { background: #dc3545; color: white; margin-left: 8px; }
    .remover:hover { background: #c82333; }
    .limpar { background: #ffc107; color: #212529; margin-bottom: 15px; }
    .limpar:hover { background: #e0a800; }
    .tag {
      background: #007bff;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    .time {
      color: #888;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>🎤 Console do Karaokê</h1>

    <div class="section" id="tocandoAgora" style="background:#e3ffe6; border-left: 5px solid #28a745;">
      <h2>🎧 Tocando Agora</h2>
      <p id="infoTocando">Nenhuma música em reprodução.</p>
    </div>

    <div class="section" id="proximaMusica" style="background:#fff7e6; border-left: 5px solid #ffa500;">
      <h2>🔜 Próxima Música da Fila</h2>
      <p id="infoProxima">Carregando...</p>
    </div>

    <div class="section">
      <h2>🎶 Fila Atual</h2>
      <button id="limparFila" class="limpar">Limpar Fila</button>
      <ul id="fila"></ul>
    </div>

    <div class="section">
      <h2>📜 Histórico de Músicas Tocadas</h2>
      <ul id="historico"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, onSnapshot,
      updateDoc, arrayRemove, serverTimestamp, query, orderBy, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGkT5z6i3KycQHvuutOYiUOeX1hDG15lw",
      authDomain: "esquina-s-karaoke.firebaseapp.com",
      projectId: "esquina-s-karaoke",
      storageBucket: "esquina-s-karaoke.firebasestorage.app",
      messagingSenderId: "259976490299",
      appId: "1:259976490299:web:a7964bf79f1ead7e5e5b1e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ulFila = document.getElementById("fila");
    const ulHist = document.getElementById("historico");
    const infoTocando = document.getElementById("infoTocando");
    const infoProxima = document.getElementById("infoProxima");

    let mesas = [];
    let filaRodizio = [];

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("limparFila").addEventListener("click", limparFila);

      onSnapshot(collection(db, "mesas"), gerarFilaRodizio);

      onSnapshot(doc(db, "sistema", "recalcularFila"), async (docSnap) => {
        if (docSnap.exists()) {
          console.log("🔄 Recalculando fila após trigger...");
          await gerarFilaRodizio();
          await setDoc(doc(db, "sistema", "recalcularFila"), { atualizar: false });
        }
      });

      const qHist = query(collection(db, "historico"), orderBy("tocadaEm", "desc"));
      onSnapshot(qHist, (snapshot) => {
        ulHist.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const time = data.tocadaEm?.toDate().toLocaleString("pt-BR") || "sem data";
          const li = document.createElement("li");
          li.innerHTML = `<span><strong>${data.musica}</strong> <span class="tag">Mesa ${data.mesa}</span></span><span class="time">${time}</span>`;
          ulHist.appendChild(li);
        });
      });

      onSnapshot(doc(db, "status", "tocandoAgora"), (docSnap) => {
        if (!docSnap.exists()) {
          infoTocando.textContent = "Nenhuma música em reprodução.";
          return;
        }

        const data = docSnap.data();
        const time = data.atualizadoEm?.toDate().toLocaleTimeString("pt-BR") || "";
        infoTocando.innerHTML = `
          <strong>${data.musica}</strong>
          <span class="tag">Mesa ${data.mesa}</span>
          <span class="time">${time}</span>
        `;
      });
    });

    async function gerarFilaRodizio() {
      const snapshot = await getDocs(collection(db, "mesas"));
      mesas = snapshot.docs.map(doc => ({
        mesaId: doc.id,
        musicas: doc.data().musicas || []
      }));

      filaRodizio = [];
      let index = 0;
      let aindaTem = true;

      while (aindaTem) {
        aindaTem = false;
        for (let mesa of mesas) {
          const primeira = mesa.musicas[index];
          const segunda = mesa.musicas[index + 1];

          if (typeof primeira === 'string') {
            const youtubeId = await buscarYoutubeId(primeira);
            if (youtubeId) {
              filaRodizio.push({ mesaId: mesa.mesaId, musica: primeira, youtubeId });
              aindaTem = true;
            }
          }

          if (typeof segunda === 'string') {
            const youtubeId2 = await buscarYoutubeId(segunda);
            if (youtubeId2) {
              filaRodizio.push({ mesaId: mesa.mesaId, musica: segunda, youtubeId: youtubeId2 });
              aindaTem = true;
            }
          }
        }
        index += 2;
      }

      await setDoc(doc(db, "sistema", "filaOrdenada"), {
        fila: filaRodizio,
        atualizadaEm: serverTimestamp()
      });

      renderizarFila();
    }

    function renderizarFila() {
      ulFila.innerHTML = '';
      if (filaRodizio.length === 0) {
        ulFila.innerHTML = '<li>Nenhuma música na fila.</li>';
        infoProxima.textContent = "Nenhuma música após a atual.";
        return;
      }

      filaRodizio.forEach((item, i) => {
        const li = document.createElement("li");
        if (i === 0) li.classList.add("atual");
        li.innerHTML = `
          <span><strong>${item.musica}</strong> <span class="tag">Mesa ${item.mesaId}</span></span>
          <span>
            ${i === 0 ? `
              <button class="tocar" onclick="forcarTocar('${item.mesaId}', \`${item.musica}\`)">Tocar agora</button>
              <button class="remover" onclick="pularMusica('${item.mesaId}', \`${item.musica}\`)">Pular</button>
            ` : `
              <button class="remover" onclick="removerMusica('${item.mesaId}', \`${item.musica}\`)">Remover</button>
            `}
          </span>
        `;
        ulFila.appendChild(li);
      });

      const proxima = filaRodizio[1];
      infoProxima.innerHTML = proxima
        ? `<strong>${proxima.musica}</strong> <span class="tag">Mesa ${proxima.mesaId}</span>`
        : "Nenhuma música após a atual.";
    }

async function buscarYoutubeId(musica) {
  try {
    if (!musica || typeof musica !== "string") return null;

    const textoLimpo = musica
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")          // remove acentos
      .replace(/[^\w\s-]/gi, "")                // remove caracteres especiais
      .replace(/\s+/g, " ")                     // remove espaços duplicados
      .trim();

    const query = encodeURIComponent(textoLimpo);

    const response = await fetch(`/api/buscar-video?musica=${query}`);
    if (!response.ok) {
      console.warn(`❌ API erro ${response.status} para: "${textoLimpo}"`);
      return null;
    }

    const json = await response.json();
    return json?.videoId?.length === 11 ? json.videoId : null;
  } catch (err) {
    console.error("Erro ao buscar YouTube ID:", err);
    return null;
  }
}

    window.forcarTocar = async (mesaId, musica) => {
      const youtubeId = await buscarYoutubeId(musica);
      if (!youtubeId) return;

      await setDoc(doc(db, "status", "forcarTocar"), {
        mesa: mesaId,
        musica,
        youtubeId,
        forcarEm: serverTimestamp()
      });
    };

    window.pularMusica = async (mesaId, musica) => {
      await removerMusica(mesaId, musica);
    };

    window.removerMusica = async (mesaId, musica) => {
      const mesaRef = doc(db, "mesas", mesaId);
      await updateDoc(mesaRef, {
        musicas: arrayRemove(musica),
        ultimaAtualizacao: serverTimestamp()
      });
      await gerarFilaRodizio();
    };

    async function limparFila() {
      const snapshot = await getDocs(collection(db, "mesas"));
      for (let docSnap of snapshot.docs) {
        const mesaRef = doc(db, "mesas", docSnap.id);
        await updateDoc(mesaRef, {
          musicas: [],
          ultimaAtualizacao: serverTimestamp()
        });
      }
      await gerarFilaRodizio();
    }
  </script>
</body>
</html>
