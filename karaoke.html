<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KaraokÃª - Esquina's Bar</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-bottom: 20px; }
    input, button {
      padding: 12px;
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #ff0080;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    ul {
      list-style: none;
      padding: 0;
      max-width: 400px;
      width: 100%;
    }
    li {
      background: white;
      padding: 12px;
      margin: 6px 0;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .destaque {
      background: #d7ffd9 !important;
    }
    .remove {
      background: red;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .mensagem {
      margin-top: 10px;
      font-weight: bold;
    }
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 9999;
    }
    #toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <h1 id="titulo">KaraokÃª</h1>

  <input type="text" id="nomeInput" placeholder="Seu nome (opcional)" />
  <input type="text" id="musicaInput" placeholder="Digite uma mÃºsica (ex: EvidÃªncias ZezÃ© Di Camargo)" />
  <button id="botaoAdicionar" onclick="adicionarMusica()">Adicionar Ã  fila</button>
  <div class="mensagem" id="mensagem"></div>
  <div class="mensagem" id="contador"></div>
  <div id="toast"></div>

  <h3>ðŸŽµ Suas mÃºsicas:</h3>
  <ul id="listaMusicas"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      arrayUnion, arrayRemove, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    

    const firebaseConfig = {
      apiKey: "AIzaSyBGkT5z6i3KycQHvuutOYiUOeX1hDG15lw",
      authDomain: "esquina-s-karaoke.firebaseapp.com",
      projectId: "esquina-s-karaoke",
      storageBucket: "esquina-s-karaoke.firebasestorage.app",
      messagingSenderId: "259976490299",
      appId: "1:259976490299:web:a7964bf79f1ead7e5e5b1e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function addMusicaNaFilaPorRodada({ mesa, musica, youtubeId, nome }) {
  const filaRef = doc(db, "sistema", "filaOrdenada");
  const filaSnap = await getDoc(filaRef);
  let fila = filaSnap.exists() ? filaSnap.data().fila || [] : [];

  // Agrupa por mesa
  const grupos = {};
  const ordem = [];

  fila.forEach(item => {
    if (!grupos[item.mesa]) {
      grupos[item.mesa] = [];
      ordem.push(item.mesa);
    }
    grupos[item.mesa].push(item);
  });

  // Adiciona nova mÃºsica no grupo da mesa correspondente
  if (!grupos[mesa]) {
    grupos[mesa] = [];
    ordem.push(mesa);
  }
  grupos[mesa].push({ mesa, musica, youtubeId, nome });

  // Reorganiza a fila com atÃ© 2 mÃºsicas por rodada por mesa
  const novaFila = [];
  let aindaTem = true;

  while (aindaTem) {
    aindaTem = false;
    for (const mesaAtual of ordem) {
      const filaMesa = grupos[mesaAtual];
      if (filaMesa && filaMesa.length) {
        novaFila.push(filaMesa.shift());
        aindaTem = aindaTem || filaMesa.length > 0;
        if (filaMesa.length) {
          novaFila.push(filaMesa.shift());
        }
      }
    }
  }

  await setDoc(filaRef, { fila: novaFila });
}

    const params = new URLSearchParams(window.location.search);
    const mesa = params.get("mesa") || "sem-mesa";
    const lista = document.getElementById("listaMusicas");
    const mensagem = document.getElementById("mensagem");
    const botao = document.getElementById("botaoAdicionar");
    const contador = document.getElementById("contador");
    if (!mesa) {
      alert("Mesa nÃ£o especificada. Use ?mesa=numero para acessar.");
      throw new Error("Mesa nÃ£o especificada");
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("titulo").textContent = `KaraokÃª - Mesa ${mesa}`;
      observarMusicas();
    });

    function showToast(text) {
      const toast = document.getElementById("toast");
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    async function adicionarMusica() {
      const musicaInput = document.getElementById("musicaInput");
      const nomeInput = document.getElementById("nomeInput");
      let nomeMusica = musicaInput.value.trim();
      const nomePessoa = nomeInput.value.trim();
      mensagem.textContent = "";
      mensagem.style.color = "green";

      if (!nomeMusica) {
        showToast("Digite o nome da mÃºsica.");
        return;
      }

      if (!nomeMusica.toLowerCase().includes("karaoke")) {
        nomeMusica += " karaoke";
      }

      botao.disabled = true;
      botao.textContent = "Adicionando...";

      try {
        const res = await fetch(`https://karaokeesquinas.vercel.app/api/buscar-video?q=${encodeURIComponent(nomeMusica)}`);
        const data = await res.json();

        if (!data.youtubeId) {
          showToast("MÃºsica nÃ£o encontrada. Tente outro nome.");
          botao.disabled = false;
          botao.textContent = "Adicionar Ã  fila";
          return;
        }

        const mesaRef = doc(db, "mesas", mesa);
        const docSnap = await getDoc(mesaRef);
        const musicasAtuais = docSnap.exists() ? docSnap.data().musicas || [] : [];

        if (musicasAtuais.length >= 2) {
          showToast("VocÃª jÃ¡ adicionou 2 mÃºsicas. Aguarde elas tocarem para adicionar mais.");
          botao.disabled = false;
          botao.textContent = "Adicionar Ã  fila";
          return;
        }

        if (!docSnap.exists()) {
          await setDoc(mesaRef, {
            musicas: [data.titulo],
            ultimaAtualizacao: serverTimestamp()
          });
        } else {
          await updateDoc(mesaRef, {
            musicas: arrayUnion(data.titulo),
            ultimaAtualizacao: serverTimestamp()
          });
        }

        await addMusicaNaFilaPorRodada({
          mesa,
          musica: data.titulo,
          youtubeId: data.youtubeId,
          nome: nomePessoa || "Cliente"
        });

        musicaInput.value = "";
        showToast(`ðŸŽ¶ Adicionada: ${data.titulo}`);
      } catch (error) {
        console.error(error);
        showToast("Erro ao adicionar mÃºsica.");
      } finally {
        botao.disabled = false;
        botao.textContent = "Adicionar Ã  fila";
      }
    }

    function observarMusicas() {
      const mesaRef = doc(db, "mesas", mesa);
      onSnapshot(mesaRef, (docSnap) => {
        const data = docSnap.data();
        const musicas = data?.musicas || [];
        renderizarLista(musicas);
        contador.textContent = `ðŸŽµ VocÃª pode adicionar ${2 - musicas.length} mÃºsica(s).`;
      });
    }

    async function removerMusica(nome) {
      const mesaRef = doc(db, "mesas", mesa);
      await updateDoc(mesaRef, {
        musicas: arrayRemove(nome),
        ultimaAtualizacao: serverTimestamp()
      });
    }

    function renderizarLista(musicas) {
      lista.innerHTML = '';
      if (musicas.length === 0) {
        lista.innerHTML = "<li>Nenhuma mÃºsica adicionada ainda.</li>";
        return;
      }

      musicas.forEach((musica) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${musica}</span> <button class="remove" onclick="removerMusica('${musica}')">Remover</button>`;
        lista.appendChild(li);
      });
    }

    window.adicionarMusica = adicionarMusica;
    window.removerMusica = removerMusica;
    
  </script>
</body>
</html>