<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karaokê - Esquina's Bar</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-bottom: 20px; }
    input, button {
      padding: 12px;
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #ff0080;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    ul {
      list-style: none;
      padding: 0;
      max-width: 400px;
      width: 100%;
    }
    li {
      background: white;
      padding: 12px;
      margin: 6px 0;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .destaque {
      background: #d1ffe8 !important;
      font-weight: bold;
    }
    .remove {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .mensagem {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1 id="titulo">Karaokê</h1>

  <input type="text" id="nomeInput" placeholder="Seu nome (opcional)" />
  <input type="text" id="musicaInput" placeholder="Digite a música (ex: Evidências Zezé Di Camargo)" />
  <button id="botaoAdicionar" onclick="adicionarMusica()">Adicionar à fila</button>
  <div class="mensagem" id="mensagem"></div>

  <h3>🎵 Suas músicas:</h3>
  <ul id="listaMusicas"></ul>

  <h3>🎤 Fila de Reprodução:</h3>
  <ul id="filaReproducao"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      arrayUnion, arrayRemove, onSnapshot, serverTimestamp,
      addDoc, collection
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGkT5z6i3KycQHvuutOYiUOeX1hDG15lw",
      authDomain: "esquina-s-karaoke.firebaseapp.com",
      projectId: "esquina-s-karaoke",
      storageBucket: "esquina-s-karaoke.firebasestorage.app",
      messagingSenderId: "259976490299",
      appId: "1:259976490299:web:a7964bf79f1ead7e5e5b1e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const mesa = params.get("mesa") || "sem-mesa";
    const lista = document.getElementById("listaMusicas");
    const filaLista = document.getElementById("filaReproducao");
    const mensagem = document.getElementById("mensagem");
    const botao = document.getElementById("botaoAdicionar");

    document.getElementById("titulo").textContent = `🎤 Karaokê - Mesa ${mesa}`;
    observarMusicas();
    observarFila();

    async function adicionarMusica() {
      const musicaInput = document.getElementById("musicaInput");
      const nomeInput = document.getElementById("nomeInput");
      let nomeMusica = musicaInput.value.trim();
      const nomePessoa = nomeInput.value.trim() || "Cliente";

      mensagem.textContent = "";

      if (!nomeMusica) {
        mensagem.textContent = "⚠️ Digite o nome da música.";
        mensagem.style.color = "red";
        return;
      }

      if (!nomeMusica.toLowerCase().includes("karaok")) {
        nomeMusica += " karaoke";
      }

      botao.disabled = true;
      botao.textContent = "🔄 Verificando...";

      try {
        const mesaRef = doc(db, "mesas", mesa);
        const docSnap = await getDoc(mesaRef);
        const musicas = docSnap.exists() ? docSnap.data().musicas || [] : [];

        if (musicas.length >= 4) {
          mensagem.textContent = "⚠️ Limite de 4 músicas por mesa atingido. Aguarde tocar uma.";
          mensagem.style.color = "red";
          botao.disabled = false;
          botao.textContent = "Adicionar à fila";
          return;
        }

        botao.textContent = "🎵 Buscando vídeo...";

        const res = await fetch(`/api/buscar-video?q=${encodeURIComponent(nomeMusica)}`);
        if (!res.ok) throw new Error("Erro ao buscar vídeo");
        const data = await res.json();

        if (!data.youtubeId) {
          mensagem.textContent = "❌ Música não encontrada. Tente outro nome.";
          mensagem.style.color = "red";
          return;
        }

        if (!docSnap.exists()) {
          await setDoc(mesaRef, {
            musicas: [data.titulo],
            ultimaAtualizacao: serverTimestamp()
          });
        } else {
          await updateDoc(mesaRef, {
            musicas: arrayUnion(data.titulo),
            ultimaAtualizacao: serverTimestamp()
          });
        }

        await addDoc(collection(db, "fila"), {
          mesa: mesa,
          musica: data.titulo,
          youtubeId: data.youtubeId,
          nome: nomePessoa,
          timestamp: serverTimestamp()
        });

        await setDoc(doc(db, "sistema", "recalcularFila"), { atualizar: true });

        musicaInput.value = "";
        mensagem.textContent = `✅ Adicionada: ${data.titulo}`;
        mensagem.style.color = "green";
      } catch (error) {
        console.error(error);
        mensagem.textContent = "⚠️ Erro ao buscar o vídeo. Tente novamente.";
        mensagem.style.color = "red";
      } finally {
        botao.disabled = false;
        botao.textContent = "Adicionar à fila";
      }
    }

    function observarMusicas() {
      const mesaRef = doc(db, "mesas", mesa);
      onSnapshot(mesaRef, (docSnap) => {
        const musicas = docSnap.data()?.musicas || [];
        renderizarLista(musicas);
      });
    }

    async function removerMusica(nome) {
      const mesaRef = doc(db, "mesas", mesa);
      await updateDoc(mesaRef, {
        musicas: arrayRemove(nome),
        ultimaAtualizacao: serverTimestamp()
      });
    }

    function renderizarLista(musicas) {
      lista.innerHTML = '';
      if (musicas.length === 0) {
        lista.innerHTML = "<li>Nenhuma música adicionada ainda.</li>";
        return;
      }
      musicas.forEach((musica) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${musica}</span> <button class="remove" onclick="removerMusica('${musica}')">Remover</button>`;
        lista.appendChild(li);
      });
    }

    function observarFila() {
      const filaRef = collection(db, "fila");
      onSnapshot(filaRef, (snapshot) => {
        const musicas = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          musicas.push({
            id: doc.id,
            mesa: data.mesa,
            musica: data.musica,
            nome: data.nome || "Cliente",
            timestamp: data.timestamp?.toDate() || new Date()
          });
        });

        musicas.sort((a, b) => a.timestamp - b.timestamp);
        renderizarFila(musicas);
      });
    }

    function renderizarFila(musicas) {
      filaLista.innerHTML = '';
      if (musicas.length === 0) {
        filaLista.innerHTML = "<li>Fila vazia no momento.</li>";
        return;
      }

      const mesasMap = {};
      musicas.forEach((item) => {
        if (!mesasMap[item.mesa]) mesasMap[item.mesa] = [];
        mesasMap[item.mesa].push(item);
      });

      Object.values(mesasMap).forEach(lista =>
        lista.sort((a, b) => a.timestamp - b.timestamp)
      );

      const filaFinal = [];
      let aindaTem = true;
      while (aindaTem) {
        aindaTem = false;
        for (const mesa in mesasMap) {
          const musicasDaMesa = mesasMap[mesa];
          if (musicasDaMesa.length > 0) {
            aindaTem = true;
            filaFinal.push(...musicasDaMesa.splice(0, 2));
          }
        }
      }

      filaFinal.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${index + 1}.</strong> ${item.musica} <small>(${item.nome} - Mesa ${item.mesa})</small>`;
        if (item.mesa === mesa) li.classList.add("destaque");
        filaLista.appendChild(li);
      });
    }

    window.adicionarMusica = adicionarMusica;
    window.removerMusica = removerMusica;
  </script>
</body>
</html>
