<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karaokê TV - Esquina's Bar</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    #video {
      width: 100%;
      max-width: 1280px;
      aspect-ratio: 16 / 9;
      margin: 20px 0;
      background-color: #111;
    }
    #info {
      font-size: 24px;
      margin-top: 20px;
      text-align: center;
    }
    #proxima {
      font-size: 18px;
      color: #aaa;
      margin-bottom: 10px;
      text-align: center;
    }
    #status {
      background: #222;
      padding: 10px 20px;
      border-radius: 8px;
      color: #0af;
    }
  </style>
</head>
<body>
  <div id="info">Aguardando próxima música...</div>
  <div id="proxima"></div>
  <div id="video"></div>
  <div id="status">🎵 TV do Karaokê</div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBGkT5z6i3KycQHvuutOYiUOeX1hDG15lw",
      authDomain: "esquina-s-karaoke.firebaseapp.com",
      projectId: "esquina-s-karaoke"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const infoDiv = document.getElementById("info");
    const proximaDiv = document.getElementById("proxima");
    let player;
    let filaAtual = [];
    let musicaTocandoId = null;

    function atualizarInfos() {
      if (!filaAtual.length) {
        infoDiv.innerText = "Aguardando próxima música...";
        proximaDiv.innerText = "";
        player?.stopVideo();
        musicaTocandoId = null;
        return;
      }
      const atual = filaAtual[0];
      const proxima = filaAtual[1];
      infoDiv.innerText = `🎤 Tocando agora: ${atual.musica} (Mesa ${atual.mesa})`;
      proximaDiv.innerText = proxima ? `🎶 Próxima: ${proxima.musica} (Mesa ${proxima.mesa})` : "";
    }

    function tocarProxima() {
      if (!filaAtual.length) {
        atualizarInfos();
        return;
      }
      const proxima = filaAtual[0];
      if (!proxima || !proxima.youtubeId) {
        console.warn("⚠️ Música inválida ou sem youtubeId:", proxima);
        removerMusicaAtual();
        return;
      }
      musicaTocandoId = proxima.youtubeId;
      atualizarInfos();
      player.loadVideoById(proxima.youtubeId);
    }

    async function removerMusicaAtual() {
      const removida = filaAtual.shift();
      await db.collection("sistema").doc("filaOrdenada").update({ musicas: filaAtual });

      if (removida?.mesa && removida?.musica) {
        await db.collection("mesas").doc(removida.mesa).update({
          musicas: firebase.firestore.FieldValue.arrayRemove(removida.musica),
          ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      if (removida?.docIdOriginal) {
        try {
          await db.collection("fila").doc(removida.docIdOriginal).delete();
          console.log(`✅ Removido também de /fila/${removida.docIdOriginal}`);
        } catch (err) {
          console.error("❌ Erro ao remover da fila original:", err);
        }
      }

      setTimeout(() => tocarProxima(), 2000);
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('video', {
        height: '100%',
        width: '100%',
        videoId: '',
        events: {
          onReady: () => {
            console.log("✅ Player pronto");
            tocarProxima();
          },
          onStateChange: event => {
            if (event.data === YT.PlayerState.ENDED && player.getVideoData().video_id === musicaTocandoId) {
              removerMusicaAtual();
            }
          },
          onError: err => {
            console.warn("❌ Erro ao carregar vídeo:", err);
            removerMusicaAtual();
          }
        },
        playerVars: {
          autoplay: 1,
          controls: 1,
          rel: 0,
          modestbranding: 1,
          origin: window.location.origin
        }
      });
    }

    db.collection("sistema").doc("filaOrdenada").onSnapshot(doc => {
      const novaFila = doc.data()?.musicas || [];
      const mesmaFila = JSON.stringify(filaAtual) === JSON.stringify(novaFila);
      filaAtual = [...novaFila];
      if (!mesmaFila && player?.getPlayerState() !== YT.PlayerState.PLAYING) {
        tocarProxima();
      } else {
        atualizarInfos();
      }
    });
  </script>
</body>
</html>