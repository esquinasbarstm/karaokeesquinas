<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karaokê TV - Esquina's Bar</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #video {
      width: 100%;
      max-width: 1000px;
      height: 562px;
      margin-bottom: 20px;
      background-color: #111;
    }

    #info {
      font-size: 20px;
      margin-bottom: 10px;
    }

    #status {
      background: #222;
      padding: 10px 20px;
      border-radius: 8px;
      color: #0af;
    }
  </style>
</head>
<body>
  <div id="info">Aguardando próxima música...</div>
  <div id="video"></div>
  <div id="status">🎵 TV do Karaokê</div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBGkT5z6i3KycQHvuutOYiUOeX1hDG15lw",
      authDomain: "esquina-s-karaoke.firebaseapp.com",
      projectId: "esquina-s-karaoke"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const infoDiv = document.getElementById("info");
    let player;
    let filaAtual = [];

    function tocarProxima() {
      if (!filaAtual.length) {
        infoDiv.innerText = "Aguardando próxima música...";
        player?.stopVideo();
        return;
      }

      const proxima = filaAtual[0];
      if (!proxima || !proxima.youtubeId) {
        console.warn("⚠️ Música inválida ou sem youtubeId:", proxima);
        removerMusicaAtual();
        return;
      }

      infoDiv.innerText = `🎤 Tocando agora: ${proxima.musica} (Mesa ${proxima.mesa})`;

      player.loadVideoById(proxima.youtubeId);
    }

    function removerMusicaAtual() {
      const removida = filaAtual.shift();
      db.collection("sistema").doc("filaOrdenada").set({ fila: filaAtual });

      if (removida?.mesa && removida?.musica) {
        db.collection("mesas").doc(removida.mesa).update({
          musicas: firebase.firestore.FieldValue.arrayRemove(removida.musica),
          ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      setTimeout(() => tocarProxima(), 2000); // Espera 2s para próxima
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('video', {
        height: '562',
        width: '1000',
        videoId: '',
        events: {
          onReady: () => tocarProxima(),
          onStateChange: event => {
            if (event.data === YT.PlayerState.ENDED) {
              removerMusicaAtual();
            }
          },
          onError: () => {
            console.warn("Erro ao tocar vídeo, pulando...");
            removerMusicaAtual();
          }
        },
        playerVars: {
          autoplay: 1,
          controls: 1,
          rel: 0,
          modestbranding: 1,
          origin: location.origin
        }
      });
    }

    db.collection("sistema").doc("filaOrdenada").onSnapshot(doc => {
      const novaFila = doc.data()?.fila || [];
      if (JSON.stringify(filaAtual) !== JSON.stringify(novaFila)) {
        filaAtual = [...novaFila];
        tocarProxima();
      }
    });
  </script>
</body>
</html>
